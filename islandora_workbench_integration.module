<?php

/**
 * @file
 * Contains islandora_workbench_integration.module.
 *
 * This module adds views and REST interfaces for Islandora Workbench.
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Entity\EntityInterface;
use Drupal\node\Entity\NodeType;
use Drupal\media\Entity\MediaType;

/**
 * Implements hook_ENTITY_TYPE_presave() for node entities.
 */
function islandora_workbench_integration_node_presave(EntityInterface $node) {
  // Get the content type of the node.
  $content_type = NodeType::load($node->bundle());

  // Check if the content type exists and if the "Create new revision"
  // option is enabled.
  if ($content_type && $content_type->shouldCreateNewRevision()) {
    // The "Create new revision" option is enabled.
    $node->setNewRevision(TRUE);
    $node->setRevisionCreationTime(Drupal::time()->getRequestTime());
  }
  else {
    // The "Create new revision" option is disabled.
    $node->setNewRevision(FALSE);
  }
}

/**
 * Implements hook_ENTITY_TYPE_presave() for media entities.
 */
function islandora_workbench_integration_media_presave(EntityInterface $media) {
  // Get the bundle (media type) of the media entity.
  $bundle = $media->bundle();

  // Load the media type entity.
  $media_type = MediaType::load($bundle);

  // Check if the media type exists and if the "Create new revision"
  // option is enabled.
  if ($media_type && $media_type->shouldCreateNewRevision()) {
    // The "Create new revision" option is enabled.
    $media->setNewRevision(TRUE);
  }
  else {
    // The "Create new revision" option is disabled.
    $media->setNewRevision(FALSE);
  }
}

/**
 * Implements hook_entity_field_access().
 *
 * This hook checks access for file uploads via REST API to avoid the
 * Content: Administer fields permission.
 */
function islandora_workbench_integration_entity_field_access($operation, $field_definition, $account, $items = NULL) {
  // We only care about the 'edit' operation to file or media entities.
  if ($operation !== 'edit' || !in_array($field_definition->getTargetEntityTypeId(), ['file', 'media'])) {
    return AccessResult::neutral();
  }

  try {
    $route_match = \Drupal::service('current_route_match');
    $route_name = $route_match->getRouteName();

    // The route name for POST file uploads from FileUploadResource.
    if ($route_name !== 'rest.file.upload.POST') {
      return AccessResult::neutral();
    }

    $request = \Drupal::requestStack()->getCurrentRequest();
    if (!$request || $request->getMethod() !== 'POST') {
      return AccessResult::neutral();
    }

    // Check if the current user has our custom permission.
    // This replaces the implicit "administer fields" requirement.
    if ($account->hasPermission('use islandora workbench')) {
      $entity_type = $field_definition->getTargetEntityTypeId();
      // Explicitly allow, and set cacheability so this is permission-based.
      return AccessResult::allowed()->cachePerPermissions();
    }
  }
  catch (Exception $e) {
    \Drupal::logger('logger.channel.islandora_workbench_integration')->error(
      'Error checking file field access for workbench user @user: @message',
      [
        '@user' => $account->id(),
        '@message' => $e->getMessage(),
      ]
    );
  }
  // Fallback to neutral to allow other checks to run.
  return AccessResult::neutral();
}
